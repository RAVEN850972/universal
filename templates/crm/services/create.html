<!-- templates/crm/services/create.html -->
{% extends 'base.html' %}

{% block title %}{% if service %}Редактирование{% else %}Создание{% endif %} услуги - {{ current_company.name }}{% endblock %}
{% block page_title %}{% if service %}Редактирование услуги{% else %}Новая услуга{% endif %}{% endblock %}
{% block page_icon %}{% if service %}edit{% else %}plus-circle{% endif %}{% endblock %}

{% block content %}
<form method="post" id="serviceForm">
    {% csrf_token %}
    <div class="row">
        <div class="col-md-8">
            <!-- Основная информация -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Основная информация
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label">
                                Название услуги <span class="text-danger">*</span>
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                            <div class="text-danger small">{{ form.name.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">Краткое и понятное название для клиентов</div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="serviceCategory" class="form-label">Категория</label>
                            <select class="form-select" id="serviceCategory" name="category">
                                <option value="">Без категории</option>
                                <option value="construction">Строительство</option>
                                <option value="repair">Ремонт</option>
                                <option value="cleaning">Уборка</option>
                                <option value="design">Дизайн</option>
                                <option value="consulting">Консультации</option>
                                <option value="installation">Установка</option>
                                <option value="maintenance">Обслуживание</option>
                                <option value="other">Другое</option>
                            </select>
                            <div class="form-text">Для группировки в отчетах</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            Описание услуги
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger small">{{ form.description.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text">Подробное описание, что включает в себя услуга</div>
                    </div>
                </div>
            </div>
            
            <!-- Ценообразование -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-money-bill-wave me-2"></i>Ценообразование
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.base_price.id_for_label }}" class="form-label">
                                Базовая цена <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                {{ form.base_price }}
                                <span class="input-group-text">₽</span>
                            </div>
                            {% if form.base_price.errors %}
                            <div class="text-danger small">{{ form.base_price.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">Стандартная цена за единицу</div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.unit.id_for_label }}" class="form-label">
                                Единица измерения <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                {{ form.unit }}
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" 
                                        data-bs-toggle="dropdown">
                                    <i class="fas fa-list"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="setUnit('шт')">шт (штука)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setUnit('час')">час</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setUnit('м²')">м² (квадратный метр)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setUnit('м')">м (метр)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setUnit('м³')">м³ (кубический метр)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setUnit('кг')">кг (килограмм)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setUnit('л')">л (литр)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setUnit('комплект')">комплект</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setUnit('услуга')">услуга</a></li>
                                </ul>
                            </div>
                            {% if form.unit.errors %}
                            <div class="text-danger small">{{ form.unit.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="minQuantity" class="form-label">Минимальное количество</label>
                            <input type="number" class="form-control" id="minQuantity" name="min_quantity" 
                                   step="0.01" min="0" value="1">
                            <div class="form-text">Минимальный заказ</div>
                        </div>
                    </div>
                    
                    <!-- Калькулятор цены -->
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-calculator me-2"></i>Калькулятор стоимости
                            </h6>
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="calcQuantity" class="form-label">Количество</label>
                                    <input type="number" class="form-control" id="calcQuantity" 
                                           value="1" step="0.01" min="0" oninput="calculatePrice()">
                                </div>
                                <div class="col-md-3">
                                    <label for="discountPercent" class="form-label">Скидка (%)</label>
                                    <input type="number" class="form-control" id="discountPercent" 
                                           value="0" step="0.1" min="0" max="100" oninput="calculatePrice()">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Итого</label>
                                    <div class="form-control-plaintext">
                                        <strong id="totalPrice" class="text-success fs-5">0 ₽</strong>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">За единицу</label>
                                    <div class="form-control-plaintext">
                                        <span id="unitPrice" class="text-muted">0 ₽</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Дополнительные параметры -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>Дополнительные параметры
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="is_active" name="is_active" 
                                       {% if not service or service.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="is_active">
                                    <strong>Активная услуга</strong>
                                    <br><small class="text-muted">Доступна для выбора в заказах</small>
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="allow_partial" name="allow_partial" checked>
                                <label class="form-check-label" for="allow_partial">
                                    <strong>Дробные количества</strong>
                                    <br><small class="text-muted">Можно заказывать 0.5, 1.5 и т.д.</small>
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="requires_measurements" name="requires_measurements">
                                <label class="form-check-label" for="requires_measurements">
                                    <strong>Требует замеров</strong>
                                    <br><small class="text-muted">Необходимы предварительные измерения</small>
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="estimatedDuration" class="form-label">Время выполнения</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="estimatedDuration" 
                                           name="estimated_duration" step="0.5" min="0" placeholder="0">
                                    <select class="form-select" style="max-width: 100px;">
                                        <option value="hours">часов</option>
                                        <option value="days">дней</option>
                                        <option value="weeks">недель</option>
                                    </select>
                                </div>
                                <div class="form-text">Примерное время выполнения</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="materials" class="form-label">Материалы</label>
                                <textarea class="form-control" id="materials" name="materials" rows="2" 
                                          placeholder="Список необходимых материалов"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="equipment" class="form-label">Оборудование</label>
                                <textarea class="form-control" id="equipment" name="equipment" rows="2" 
                                          placeholder="Необходимое оборудование или инструменты"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if service %}
            <!-- Статистика использования -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Статистика использования
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h4 class="text-primary">{{ service.order_services.count }}</h4>
                            <small class="text-muted">Всего заказов</small>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-success">{{ service.total_revenue|default:0|floatformat:0 }}₽</h4>
                            <small class="text-muted">Общий доход</small>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-info">{{ service.avg_quantity|default:0|floatformat:1 }}</h4>
                            <small class="text-muted">Среднее количество</small>
                        </div>
                        <div class="col-md-3">
                            <h4 class="text-warning">{{ service.last_used|timesince|default:"Никогда" }}</h4>
                            <small class="text-muted">Последнее использование</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Боковая панель -->
        <div class="col-md-4">
            <!-- Действия -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Действия</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            {% if service %}Сохранить изменения{% else %}Создать услугу{% endif %}
                        </button>
                        
                        {% if service %}
                        <button type="button" class="btn btn-outline-info" onclick="duplicateService()">
                            <i class="fas fa-copy me-2"></i>Дублировать
                        </button>
                        {% endif %}
                        
                        <a href="{% url 'services_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>К списку услуг
                        </a>
                    </div>
                    
                    {% if not service %}
                    <hr>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="create_another" name="create_another">
                        <label class="form-check-label" for="create_another">
                            Создать еще одну услугу
                        </label>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Шаблоны услуг -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-magic me-2"></i>Шаблоны услуг
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="applyTemplate('construction')">
                            <i class="fas fa-hammer me-2"></i>Строительство
                        </button>
                        
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="applyTemplate('repair')">
                            <i class="fas fa-wrench me-2"></i>Ремонт
                        </button>
                        
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="applyTemplate('cleaning')">
                            <i class="fas fa-broom me-2"></i>Уборка
                        </button>
                        
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="applyTemplate('design')">
                            <i class="fas fa-paint-brush me-2"></i>Дизайн
                        </button>
                        
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="applyTemplate('consulting')">
                            <i class="fas fa-user-tie me-2"></i>Консультации
                        </button>
                    </div>
                    
                    <div class="form-text mt-2">
                        Быстрое заполнение типовых параметров
                    </div>
                </div>
            </div>
            
            <!-- Рыночные цены -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Рыночные цены
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">Ремонт квартир (м²):</small><br>
                        <strong>2,000 - 5,000₽</strong>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Уборка (час):</small><br>
                        <strong>300 - 800₽</strong>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Сантехника (услуга):</strong><br>
                        <strong>1,500 - 3,000₽</strong>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Дизайн (м²):</small><br>
                        <strong>1,000 - 3,000₽</strong>
                    </div>
                    
                    <hr>
                    
                    <div class="text-center">
                        <small class="text-muted">Данные на {{ "now"|date:"m.Y" }}</small><br>
                        <small class="text-muted">Московский регион</small>
                    </div>
                </div>
            </div>
            
            <!-- Похожие услуги -->
            {% if similar_services %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Похожие услуги
                    </h6>
                </div>
                <div class="card-body">
                    {% for similar in similar_services %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <small class="fw-bold">{{ similar.name|truncatechars:20 }}</small><br>
                            <small class="text-muted">{{ similar.base_price|floatformat:0 }}₽/{{ similar.unit }}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="copyPriceFrom({{ similar.base_price }}, '{{ similar.unit }}')">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
// Установка единицы измерения
function setUnit(unit) {
    document.getElementById('{{ form.unit.id_for_label }}').value = unit;
    calculatePrice();
}

// Калькулятор цены
function calculatePrice() {
    const basePrice = parseFloat(document.getElementById('{{ form.base_price.id_for_label }}').value) || 0;
    const quantity = parseFloat(document.getElementById('calcQuantity').value) || 0;
    const discount = parseFloat(document.getElementById('discountPercent').value) || 0;
    
    const subtotal = basePrice * quantity;
    const discountAmount = (subtotal * discount) / 100;
    const total = subtotal - discountAmount;
    
    document.getElementById('totalPrice').textContent = total.toLocaleString() + ' ₽';
    document.getElementById('unitPrice').textContent = (total / (quantity || 1)).toLocaleString() + ' ₽';
}

// Шаблоны услуг
function applyTemplate(type) {
    const templates = {
        construction: {
            name: 'Строительные работы',
            description: 'Полный комплекс строительных работ включая подготовку, возведение конструкций и отделку',
            base_price: 2500,
            unit: 'м²',
            category: 'construction',
            estimated_duration: 5,
            requires_measurements: true
        },
        repair: {
            name: 'Ремонт квартиры',
            description: 'Косметический и капитальный ремонт жилых помещений',
            base_price: 3000,
            unit: 'м²',
            category: 'repair',
            estimated_duration: 7,
            requires_measurements: true
        },
        cleaning: {
            name: 'Уборка помещений',
            description: 'Профессиональная уборка офисов и квартир',
            base_price: 500,
            unit: 'час',
            category: 'cleaning',
            estimated_duration: 2,
            requires_measurements: false
        },
        design: {
            name: 'Дизайн интерьера',
            description: 'Создание дизайн-проекта интерьера с 3D визуализацией',
            base_price: 2000,
            unit: 'м²',
            category: 'design',
            estimated_duration: 14,
            requires_measurements: true
        },
        consulting: {
            name: 'Консультация специалиста',
            description: 'Профессиональная консультация по вопросам строительства и ремонта',
            base_price: 1500,
            unit: 'час',
            category: 'consulting',
            estimated_duration: 1,
            requires_measurements: false
        }
    };
    
    const template = templates[type];
    if (template) {
        document.getElementById('{{ form.name.id_for_label }}').value = template.name;
        document.getElementById('{{ form.description.id_for_label }}').value = template.description;
        document.getElementById('{{ form.base_price.id_for_label }}').value = template.base_price;
        document.getElementById('{{ form.unit.id_for_label }}').value = template.unit;
        document.getElementById('serviceCategory').value = template.category;
        document.getElementById('estimatedDuration').value = template.estimated_duration;
        document.getElementById('requires_measurements').checked = template.requires_measurements;
        
        calculatePrice();
    }
}

// Копирование цены от похожей услуги
function copyPriceFrom(price, unit) {
    if (confirm(`Установить цену ${price}₽ за ${unit}?`)) {
        document.getElementById('{{ form.base_price.id_for_label }}').value = price;
        document.getElementById('{{ form.unit.id_for_label }}').value = unit;
        calculatePrice();
    }
}

// Дублирование услуги
function duplicateService() {
    if (confirm('Создать копию текущей услуги?')) {
        // Меняем action формы для дублирования
        const form = document.getElementById('serviceForm');
        const originalAction = form.action;
        
        // Добавляем скрытое поле для дублирования
        const duplicateInput = document.createElement('input');
        duplicateInput.type = 'hidden';
        duplicateInput.name = 'duplicate';
        duplicateInput.value = 'true';
        form.appendChild(duplicateInput);
        
        // Меняем название на "Копия ..."
        const nameField = document.getElementById('{{ form.name.id_for_label }}');
        if (!nameField.value.startsWith('Копия ')) {
            nameField.value = 'Копия ' + nameField.value;
        }
        
        form.submit();
    }
}

// Автообновление калькулятора при изменении базовой цены
document.getElementById('{{ form.base_price.id_for_label }}').addEventListener('input', calculatePrice);

// Валидация формы
document.getElementById('serviceForm').addEventListener('submit', function(e) {
    const name = document.getElementById('{{ form.name.id_for_label }}').value.trim();
    const basePrice = document.getElementById('{{ form.base_price.id_for_label }}').value;
    const unit = document.getElementById('{{ form.unit.id_for_label }}').value.trim();
    
    if (!name) {
        e.preventDefault();
        alert('Введите название услуги');
        document.getElementById('{{ form.name.id_for_label }}').focus();
        return;
    }
    
    if (!basePrice || parseFloat(basePrice) <= 0) {
        e.preventDefault();
        alert('Введите корректную базовую цену');
        document.getElementById('{{ form.base_price.id_for_label }}').focus();
        return;
    }
    
    if (!unit) {
        e.preventDefault();
        alert('Введите единицу измерения');
        document.getElementById('{{ form.unit.id_for_label }}').focus();
        return;
    }
    
    // Показываем индикатор загрузки
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Сохранение...';
    submitBtn.disabled = true;
    
    // Восстанавливаем кнопку через 10 секунд на случай ошибки
    setTimeout(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }, 10000);
});

// Проверка уникальности названия
let nameCheckTimeout;
document.getElementById('{{ form.name.id_for_label }}').addEventListener('input', function() {
    const name = this.value.trim();
    
    if (name.length > 2) {
        clearTimeout(nameCheckTimeout);
        nameCheckTimeout = setTimeout(() => {
            fetch(`/api/services/check-name/?name=${encodeURIComponent(name)}{% if service %}&exclude={{ service.id }}{% endif %}`)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        showNameWarning();
                    } else {
                        hideNameWarning();
                    }
                })
                .catch(error => console.error('Error:', error));
        }, 1000);
    }
});

function showNameWarning() {
    hideNameWarning();
    
    const nameField = document.getElementById('{{ form.name.id_for_label }}');
    const warning = document.createElement('div');
    warning.id = 'nameWarning';
    warning.className = 'alert alert-warning mt-2';
    warning.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        Услуга с таким названием уже существует
    `;
    
    nameField.parentNode.appendChild(warning);
}

function hideNameWarning() {
    const warning = document.getElementById('nameWarning');
    if (warning) {
        warning.remove();
    }
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    calculatePrice();
    
    // Устанавливаем фокус на название при создании новой услуги
    {% if not service %}
    document.getElementById('{{ form.name.id_for_label }}').focus();
    {% endif %}
});

// Автосохранение в localStorage для новых услуг
{% if not service %}
function autoSave() {
    const formData = {
        name: document.getElementById('{{ form.name.id_for_label }}').value,
        description: document.getElementById('{{ form.description.id_for_label }}').value,
        base_price: document.getElementById('{{ form.base_price.id_for_label }}').value,
        unit: document.getElementById('{{ form.unit.id_for_label }}').value,
        category: document.getElementById('serviceCategory').value
    };
    localStorage.setItem('serviceDraft', JSON.stringify(formData));
}

function restoreDraft() {
   const draft = localStorage.getItem('serviceDraft');
   if (draft && confirm('Восстановить несохраненные данные услуги?')) {
       const data = JSON.parse(draft);
       
       Object.keys(data).forEach(key => {
           const field = document.getElementById(key === 'category' ? 'serviceCategory' : `id_${key}`);
           if (field && data[key]) {
               field.value = data[key];
           }
       });
       
       localStorage.removeItem('serviceDraft');
       calculatePrice();
   }
}

// Восстанавливаем черновик при загрузке
document.addEventListener('DOMContentLoaded', function() {
   restoreDraft();
   
   // Автосохранение каждые 30 секунд
   setInterval(autoSave, 30000);
});

// Очистка автосохранения при отправке формы
document.getElementById('serviceForm').addEventListener('submit', function() {
   localStorage.removeItem('serviceDraft');
});
{% endif %}

// Горячие клавиши
document.addEventListener('keydown', function(e) {
   // Ctrl+S - сохранить
   if (e.ctrlKey && e.key === 's') {
       e.preventDefault();
       document.getElementById('serviceForm').submit();
   }
   
   // Ctrl+D - дублировать (только при редактировании)
   {% if service %}
   if (e.ctrlKey && e.key === 'd') {
       e.preventDefault();
       duplicateService();
   }
   {% endif %}
   
   // Escape - вернуться к списку
   if (e.key === 'Escape') {
       if (confirm('Вернуться к списку услуг? Несохраненные изменения будут потеряны.')) {
           window.location.href = '{% url "services_list" %}';
       }
   }
});
</script>
{% endblock %}