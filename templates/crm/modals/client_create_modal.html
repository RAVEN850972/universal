<!-- templates/crm/modals/client_create_modal.html -->
{% extends "crm/modals/base_modal.html" %}

{% block modal_title %}Создать нового клиента{% endblock %}

{% block modal_body %}
<form id="clientCreateForm" method="post">
    {% csrf_token %}
    
    <div class="row">
        <div class="col-md-6">
            <!-- Имя клиента -->
            <div class="mb-3">
                <label for="{{ form.name.id_for_label }}" class="form-label">
                    Название/Имя клиента <span class="text-danger">*</span>
                </label>
                {{ form.name }}
                {% if form.name.errors %}
                <div class="text-danger small">{{ form.name.errors.0 }}</div>
                {% endif %}
            </div>
            
            <!-- Телефон -->
            <div class="mb-3">
                <label for="{{ form.phone.id_for_label }}" class="form-label">Телефон</label>
                {{ form.phone }}
                {% if form.phone.errors %}
                <div class="text-danger small">{{ form.phone.errors.0 }}</div>
                {% endif %}
            </div>
            
            <!-- Email -->
            <div class="mb-3">
                <label for="{{ form.email.id_for_label }}" class="form-label">Email</label>
                {{ form.email }}
                {% if form.email.errors %}
                <div class="text-danger small">{{ form.email.errors.0 }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-6">
            <!-- Источник -->
            <div class="mb-3">
                <label for="{{ form.source.id_for_label }}" class="form-label">Источник</label>
                {{ form.source }}
                {% if form.source.errors %}
                <div class="text-danger small">{{ form.source.errors.0 }}</div>
                {% endif %}
            </div>
            
            <!-- Адрес -->
            <div class="mb-3">
                <label for="{{ form.address.id_for_label }}" class="form-label">Адрес</label>
                {{ form.address }}
                {% if form.address.errors %}
                <div class="text-danger small">{{ form.address.errors.0 }}</div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Заметки -->
    <div class="mb-3">
        <label for="{{ form.notes.id_for_label }}" class="form-label">Заметки</label>
        {{ form.notes }}
        {% if form.notes.errors %}
        <div class="text-danger small">{{ form.notes.errors.0 }}</div>
        {% endif %}
    </div>
</form>
{% endblock %}

{% block modal_footer %}
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
<button type="submit" form="clientCreateForm" class="btn btn-primary">
    <i class="fas fa-save"></i> Создать клиента
</button>

<script>
document.getElementById('clientCreateForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/modals/clients/create/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            closeModal();
            
            // Если есть callback функция, вызываем её
            if (window.onClientCreated) {
                window.onClientCreated(data.client_id, data.client_name);
            }
            
            // Обновляем страницу через секунду
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showAlert('danger', data.error || 'Ошибка создания клиента');
        }
    })
    .catch(error => {
        showAlert('danger', 'Ошибка сети');
        console.error('Error:', error);
    });
});
</script>
{% endblock %}