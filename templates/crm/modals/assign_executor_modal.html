<!-- templates/crm/modals/assign_executor_modal.html -->
{% extends "crm/modals/base_modal.html" %}

{% block modal_title %}Назначить исполнителя на заказ #{{ order.id }}{% endblock %}

{% block modal_body %}
<form id="assignExecutorForm" method="post">
    {% csrf_token %}
    
    <div class="mb-3">
        <h6 class="text-muted">Заказ: {{ order.client.name }} - {{ order.total_amount }} ₽</h6>
    </div>
    
    {% if executors %}
    <div class="mb-3">
        <label for="executor_id" class="form-label">Выберите исполнителя <span class="text-danger">*</span></label>
        <select class="form-select" id="executor_id" name="executor_id" required>
            <option value="">Выберите исполнителя</option>
            {% for executor in executors %}
            <option value="{{ executor.user.id }}" data-rate="{{ executor.commission_rate }}">
                {{ executor.user.get_full_name }} 
                ({{ executor.get_role_display }}, комиссия {{ executor.commission_rate }}%)
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="work_hours" class="form-label">Планируемые часы работы</label>
                <input type="number" class="form-control" id="work_hours" name="work_hours" 
                       min="0" step="0.5" value="8">
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <label for="commission_rate" class="form-label">Процент комиссии (%)</label>
                <input type="number" class="form-control" id="commission_rate" name="commission_rate" 
                       min="0" max="100" step="0.1" value="0">
            </div>
        </div>
    </div>
    
    <div class="mb-3">
        <label class="form-label">Расчетная комиссия</label>
        <div class="form-control bg-light" id="calculatedCommission">0.00 ₽</div>
    </div>
    
    <!-- Информация об исполнителе -->
    <div id="executorInfo" class="card bg-light d-none">
        <div class="card-body">
            <h6 class="card-title">Информация об исполнителе</h6>
            <div class="row">
                <div class="col-md-4">
                    <small class="text-muted">Активных заказов:</small>
                    <div id="executorActiveOrders">-</div>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Завершенных заказов:</small>
                    <div id="executorCompletedOrders">-</div>
                </div>
                <div class="col-md-4">
                    <small class="text-muted">Рейтинг:</small>
                    <div id="executorRating">-</div>
                </div>
            </div>
        </div>
    </div>
    
    {% else %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Нет доступных исполнителей для назначения на этот заказ.
    </div>
    {% endif %}
</form>
{% endblock %}

{% block modal_footer %}
{% if executors %}
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
<button type="submit" form="assignExecutorForm" class="btn btn-success">
    <i class="fas fa-user-plus"></i> Назначить исполнителя
</button>
{% else %}
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
{% endif %}

<script>
const orderTotal = {{ order.total_amount }};

// Обработчик отправки формы
document.getElementById('assignExecutorForm')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/modals/orders/{{ order.id }}/assign-executor/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            closeModal();
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showAlert('danger', data.error || 'Ошибка назначения исполнителя');
        }
    })
    .catch(error => {
        showAlert('danger', 'Ошибка сети');
        console.error('Error:', error);
    });
});

// Обработчик выбора исполнителя
document.getElementById('executor_id')?.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const commissionRateInput = document.getElementById('commission_rate');
    
    if (selectedOption.value) {
        // Устанавливаем комиссию по умолчанию
        const defaultRate = selectedOption.dataset.rate || 0;
        commissionRateInput.value = defaultRate;
        
        // Показываем информацию об исполнителе
        showExecutorInfo(selectedOption.value);
        
        // Рассчитываем комиссию
        calculateCommission();
    } else {
        hideExecutorInfo();
        document.getElementById('calculatedCommission').textContent = '0.00 ₽';
    }
});

// Обработчик изменения процента комиссии
document.getElementById('commission_rate')?.addEventListener('input', calculateCommission);

// Расчет комиссии
function calculateCommission() {
    const rate = parseFloat(document.getElementById('commission_rate').value) || 0;
    const commission = (orderTotal * rate) / 100;
    document.getElementById('calculatedCommission').textContent = commission.toFixed(2) + ' ₽';
}

// Показать информацию об исполнителе
function showExecutorInfo(executorId) {
    // Здесь можно сделать AJAX запрос для получения подробной информации
    // Пока показываем заглушку
    document.getElementById('executorInfo').classList.remove('d-none');
    
    // Можно добавить реальный API вызов:
    // fetch(`/api/executors/${executorId}/stats/`)
    //     .then(response => response.json())
    //     .then(data => {
    //         document.getElementById('executorActiveOrders').textContent = data.active_orders;
    //         document.getElementById('executorCompletedOrders').textContent = data.completed_orders;
    //         document.getElementById('executorRating').innerHTML = '★'.repeat(data.rating);
    //     });
}

// Скрыть информацию об исполнителе
function hideExecutorInfo() {
    document.getElementById('executorInfo').classList.add('d-none');
}
</script>
{% endblock %}