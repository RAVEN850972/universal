<!-- templates/crm/modals/orders_report_modal.html -->
{% extends "crm/modals/base_modal.html" %}

{% block modal_title %}Отчет по заказам{% endblock %}

{% block modal_size %}modal-xl{% endblock %}

{% block modal_body %}
<div class="row mb-4">
    <div class="col-md-8">
        <h6 class="text-muted">
            Период: {{ date_from|date:"d.m.Y" }} - {{ date_to|date:"d.m.Y" }}
        </h6>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportReport('excel')">
                <i class="fas fa-file-excel"></i> Excel
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="exportReport('pdf')">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
        </div>
    </div>
</div>

<!-- Общая статистика -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <div class="h3 text-primary mb-1">{{ stats.total_orders }}</div>
                <div class="text-muted small">Всего заказов</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <div class="h3 text-success mb-1">{{ stats.total_amount|floatformat:0 }} ₽</div>
                <div class="text-muted small">Общая сумма</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <div class="h3 text-info mb-1">
                    {% if stats.total_orders > 0 %}
                        {{ stats.total_amount|floatformat:0|div:stats.total_orders|floatformat:0 }} ₽
                    {% else %}
                        0 ₽
                    {% endif %}
                </div>
                <div class="text-muted small">Средний чек</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body py-3">
                <div class="h3 text-warning mb-1">
                    {% if stats.by_status.completed %}
                        {{ stats.by_status.completed.count|floatformat:0|div:stats.total_orders|mul:100|floatformat:1 }}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
                <div class="text-muted small">Завершено</div>
            </div>
        </div>
    </div>
</div>

<!-- Статистика по статусам -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Распределение по статусам</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Статус</th>
                                <th class="text-center">Количество</th>
                                <th class="text-end">Сумма</th>
                                <th class="text-center">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for status_code, status_data in stats.by_status.items %}
                            <tr>
                                <td>
                                    <span class="badge bg-{% if status_code == 'completed' %}success{% elif status_code == 'in_progress' %}warning{% elif status_code == 'new' %}primary{% else %}secondary{% endif %}">
                                        {{ status_data.name }}
                                    </span>
                                </td>
                                <td class="text-center">{{ status_data.count }}</td>
                                <td class="text-end">{{ status_data.amount|floatformat:2 }} ₽</td>
                                <td class="text-center">
                                    {% if stats.total_orders > 0 %}
                                        {% widthratio status_data.count stats.total_orders 100 %}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Графическое представление</h6>
            </div>
            <div class="card-body">
                <canvas id="statusChart" width="300" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Детальные фильтры -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Фильтры отчета</h6>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="applyFilters()">
                    <i class="fas fa-filter"></i> Применить
                </button>
            </div>
            <div class="card-body">
                <form id="reportFilters">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Период</label>
                            <select class="form-select form-select-sm" name="period">
                                <option value="current_month" {% if period == 'current_month' %}selected{% endif %}>Текущий месяц</option>
                                <option value="last_month" {% if period == 'last_month' %}selected{% endif %}>Прошлый месяц</option>
                                <option value="current_quarter" {% if period == 'current_quarter' %}selected{% endif %}>Текущий квартал</option>
                                <option value="current_year" {% if period == 'current_year' %}selected{% endif %}>Текущий год</option>
                                <option value="custom">Произвольный</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Статус</label>
                            <select class="form-select form-select-sm" name="status">
                                <option value="all">Все статусы</option>
                                {% for status_code, status_name in status_choices %}
                                <option value="{{ status_code }}" {% if status_filter == status_code %}selected{% endif %}>
                                    {{ status_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Дата от</label>
                            <input type="date" class="form-control form-control-sm" name="date_from" 
                                   value="{{ date_from|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Дата до</label>
                            <input type="date" class="form-control form-control-sm" name="date_to" 
                                   value="{{ date_to|date:'Y-m-d' }}">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modal_footer %}
<div class="d-flex justify-content-between w-100">
    <div>
        <button type="button" class="btn btn-outline-info" onclick="printReport()">
            <i class="fas fa-print"></i> Печать
        </button>
    </div>
    <div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
        <button type="button" class="btn btn-primary" onclick="refreshReport()">
            <i class="fas fa-sync"></i> Обновить
        </button>
    </div>
</div>

<script>
// Данные для графика
const chartData = {
    labels: [
        {% for status_code, status_data in stats.by_status.items %}
        '{{ status_data.name }}'{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    datasets: [{
        data: [
            {% for status_code, status_data in stats.by_status.items %}
            {{ status_data.count }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        backgroundColor: [
            {% for status_code, status_data in stats.by_status.items %}
            {% if status_code == 'completed' %}'#28a745'
            {% elif status_code == 'in_progress' %}'#ffc107'
            {% elif status_code == 'new' %}'#007bff'
            {% else %}'#6c757d'{% endif %}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }]
};

// Инициализация графика
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('statusChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
});

// Применение фильтров
function applyFilters() {
    const form = document.getElementById('reportFilters');
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);
    
    // Перезагружаем модальное окно с новыми параметрами
    loadModal(`/modals/reports/orders/?${params.toString()}`, 'Отчет по заказам', 'xl');
}

// Обновление отчета
function refreshReport() {
    applyFilters();
}

// Экспорт отчета
function exportReport(format) {
    const form = document.getElementById('reportFilters');
    const formData = new FormData(form);
    formData.append('format', format);
    
    // Создаем скрытую форму для загрузки файла
    const downloadForm = document.createElement('form');
    downloadForm.method = 'POST';
    downloadForm.action = '/api/reports/orders/export/';
    downloadForm.style.display = 'none';
    
    // Добавляем CSRF токен
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = getCookie('csrftoken');
    downloadForm.appendChild(csrfInput);
    
    // Добавляем все поля из формы фильтров
    for (const [key, value] of formData.entries()) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        downloadForm.appendChild(input);
    }
    
    document.body.appendChild(downloadForm);
    downloadForm.submit();
    document.body.removeChild(downloadForm);
}

// Печать отчета
function printReport() {
    // Создаем версию для печати
    const printContent = document.querySelector('.modal-body').innerHTML;
    const printWindow = window.open('', '_blank');
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Отчет по заказам</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                @media print {
                    .btn-group, .card-header button, .no-print { display: none !important; }
                    .card { border: 1px solid #dee2e6 !important; }
                }
                body { font-size: 12px; }
                .h3 { font-size: 1.5rem; }
            </style>
        </head>
        <body>
            <div class="container-fluid">
                <h2 class="mb-4">Отчет по заказам</h2>
                ${printContent}
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    setTimeout(() => {
        printWindow.print();
        printWindow.close();
    }, 500);
}

// Обработчик изменения периода
document.querySelector('select[name="period"]')?.addEventListener('change', function() {
    const customFields = document.querySelectorAll('input[name="date_from"], input[name="date_to"]');
    
    if (this.value === 'custom') {
        customFields.forEach(field => field.disabled = false);
    } else {
        customFields.forEach(field => field.disabled = true);
    }
});
</script>

<!-- Подключаем Chart.js если еще не подключен -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}