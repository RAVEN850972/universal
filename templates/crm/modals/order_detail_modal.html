<!-- templates/crm/modals/order_detail_modal.html -->
{% extends "crm/modals/base_modal.html" %}

{% block modal_title %}Заказ #{{ order.id }} - {{ order.client.name }}{% endblock %}

{% block modal_size %}modal-xl{% endblock %}

{% block modal_body %}
<div class="row">
    <!-- Основная информация -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Информация о заказе</h6>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-sm-4"><strong>Статус:</strong></div>
                    <div class="col-sm-8">
                        {% if can_change_status %}
                        <select class="form-select form-select-sm" id="orderStatusSelect" data-order-id="{{ order.id }}">
                            {% for status_code, status_name in status_choices %}
                            <option value="{{ status_code }}" {% if order.status == status_code %}selected{% endif %}>
                                {{ status_name }}
                            </option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <span class="badge bg-{% if order.status == 'completed' %}success{% elif order.status == 'in_progress' %}warning{% elif order.status == 'new' %}primary{% else %}secondary{% endif %}">
                            {{ order.get_status_display }}
                        </span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-sm-4"><strong>Клиент:</strong></div>
                    <div class="col-sm-8">
                        <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#clientDetailModal" data-client-id="{{ order.client.id }}">
                            {{ order.client.name }}
                        </a>
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-sm-4"><strong>Сумма:</strong></div>
                    <div class="col-sm-8">
                        <strong class="text-success">{{ order.total_amount|floatformat:2 }} ₽</strong>
                    </div>
                </div>
                
                <div class="row mb-2">
                    <div class="col-sm-4"><strong>Дата заказа:</strong></div>
                    <div class="col-sm-8">{{ order.order_date|date:"d.m.Y H:i" }}</div>
                </div>
                
                {% if order.completion_date %}
                <div class="row mb-2">
                    <div class="col-sm-4"><strong>Дата завершения:</strong></div>
                    <div class="col-sm-8">{{ order.completion_date|date:"d.m.Y H:i" }}</div>
                </div>
                {% endif %}
                
                <div class="row mb-2">
                    <div class="col-sm-4"><strong>Создал:</strong></div>
                    <div class="col-sm-8">{{ order.created_by.get_full_name }}</div>
                </div>
                
                {% if order.description %}
                <div class="row">
                    <div class="col-12">
                        <strong>Описание:</strong>
                        <p class="mt-1">{{ order.description }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Статистика работы -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Статистика работы</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="h4 text-primary mb-0">{{ total_work_hours|floatformat:1 }}</div>
                        <small class="text-muted">Часов работы</small>
                    </div>
                    <div class="col-4">
                        <div class="h4 text-success mb-0">{{ total_commission|floatformat:0 }} ₽</div>
                        <small class="text-muted">Комиссия</small>
                    </div>
                    <div class="col-4">
                        <div class="h4 text-info mb-0">{{ order_executors|length }}</div>
                        <small class="text-muted">Исполнителей</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Услуги и исполнители -->
    <div class="col-md-6">
        <!-- Услуги в заказе -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Услуги</h6>
                {% if can_edit %}
                <button class="btn btn-sm btn-outline-primary" onclick="editOrder({{ order.id }})">
                    <i class="fas fa-edit"></i>
                </button>
                {% endif %}
            </div>
            <div class="card-body p-0">
                {% if order_services %}
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Услуга</th>
                                <th>Кол-во</th>
                                <th>Цена</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order_service in order_services %}
                            <tr>
                                <td>
                                    <div class="fw-medium">{{ order_service.service.name }}</div>
                                    {% if order_service.notes %}
                                    <small class="text-muted">{{ order_service.notes }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ order_service.quantity|floatformat:0 }} {{ order_service.service.unit }}</td>
                                <td>{{ order_service.unit_price|floatformat:2 }} ₽</td>
                                <td><strong>{{ order_service.total_price|floatformat:2 }} ₽</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-3 text-muted">
                    Услуги не добавлены
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Исполнители -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Исполнители</h6>
                {% if can_edit %}
                <button class="btn btn-sm btn-outline-success" onclick="assignExecutor({{ order.id }})">
                    <i class="fas fa-plus"></i> Назначить
                </button>
                {% endif %}
            </div>
            <div class="card-body p-0">
                {% if order_executors %}
                <div class="list-group list-group-flush">
                    {% for executor in order_executors %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="fw-medium">{{ executor.user.get_full_name }}</div>
                                <small class="text-muted">
                                    {{ executor.work_hours|floatformat:1 }} ч. | {{ executor.commission_amount|floatformat:0 }} ₽
                                </small>
                            </div>
                            <div>
                                <span class="badge bg-{% if executor.status == 'completed' %}success{% elif executor.status == 'in_progress' %}warning{% else %}secondary{% endif %}">
                                    {{ executor.get_status_display }}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3 text-muted">
                    Исполнители не назначены
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block modal_footer %}
<div class="d-flex justify-content-between w-100">
    <div>
        {% if can_edit %}
        <button type="button" class="btn btn-outline-primary" onclick="editOrder({{ order.id }})">
            <i class="fas fa-edit"></i> Редактировать
        </button>
        {% endif %}
    </div>
    <div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
        {% if order.status != 'completed' and can_change_status %}
        <button type="button" class="btn btn-success" onclick="quickCompleteOrder({{ order.id }})">
            <i class="fas fa-check"></i> Завершить заказ
        </button>
        {% endif %}
    </div>
</div>

<script>
// Обработчик изменения статуса
document.getElementById('orderStatusSelect')?.addEventListener('change', function() {
    const orderId = this.dataset.orderId;
    const newStatus = this.value;
    
    fetch(`/quick/orders/${orderId}/status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `status=${newStatus}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            // Обновляем страницу или конкретные элементы
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showAlert('danger', data.error || 'Ошибка обновления статуса');
        }
    })
    .catch(error => {
        showAlert('danger', 'Ошибка сети');
        console.error('Error:', error);
    });
});

function quickCompleteOrder(orderId) {
    if (confirm('Завершить заказ?')) {
        fetch(`/quick/orders/${orderId}/status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: 'status=completed'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', 'Заказ завершен!');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        });
    }
}

function editOrder(orderId) {
    loadModal(`/modals/orders/${orderId}/edit/`, 'Редактировать заказ');
}

function assignExecutor(orderId) {
    loadModal(`/modals/orders/${orderId}/assign-executor/`, 'Назначить исполнителя');
}
</script>
{% endblock %}