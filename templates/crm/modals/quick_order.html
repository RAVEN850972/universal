<!-- templates/crm/modals/quick_order.html -->
<div class="modal-backdrop" id="quickOrderModalBackdrop" style="display: none;" onclick="hideModal('quickOrderModal')"></div>

<div class="modal" id="quickOrderModal" style="display: none;">
    <div class="modal-header">
        <h5 class="modal-title">
            <i class="fas fa-plus-circle me-2"></i>
            –ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
        </h5>
        <button type="button" class="modal-close" onclick="hideModal('quickOrderModal')">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="modal-body">
        <form id="quickOrderForm" novalidate>
            {% csrf_token %}
            
            <!-- –ö–ª–∏–µ–Ω—Ç -->
            <div class="form-group">
                <label for="quickOrderClient" class="form-label required">–ö–ª–∏–µ–Ω—Ç</label>
                <div class="autocomplete-container">
                    <div class="input-group">
                        <i class="input-icon fas fa-user"></i>
                        <input type="text" 
                               id="quickOrderClient" 
                               name="client_name" 
                               class="form-control has-icon" 
                               placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞..."
                               required
                               autocomplete="off">
                        <input type="hidden" id="quickOrderClientId" name="client_id">
                    </div>
                </div>
                <div class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–≥–æ</div>
            </div>
            
            <!-- –î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞ -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="quickOrderDate" class="form-label required">–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞</label>
                        <div class="input-group">
                            <i class="input-icon fas fa-calendar"></i>
                            <input type="date" 
                                   id="quickOrderDate" 
                                   name="order_date" 
                                   class="form-control has-icon" 
                                   required
                                   value="{{ today|date:'Y-m-d' }}">
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="quickOrderPriority" class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                        <select id="quickOrderPriority" name="priority" class="form-control">
                            <option value="normal">–û–±—ã—á–Ω—ã–π</option>
                            <option value="high">–í—ã—Å–æ–∫–∏–π</option>
                            <option value="urgent">–°—Ä–æ—á–Ω—ã–π</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- –£—Å–ª—É–≥–∞ -->
            <div class="form-group">
                <label for="quickOrderService" class="form-label">–£—Å–ª—É–≥–∞</label>
                <select id="quickOrderService" name="service_id" class="form-control">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</option>
                    {% for service in services %}
                    <option value="{{ service.id }}" data-price="{{ service.base_price }}">
                        {{ service.name }} - {{ service.base_price }}‚ÇΩ
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="form-group">
                <label for="quickOrderDescription" class="form-label required">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç</label>
                <textarea id="quickOrderDescription" 
                          name="description" 
                          class="form-control" 
                          rows="3"
                          placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å..."
                          required></textarea>
            </div>
            
            <!-- –°—É–º–º–∞ -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="quickOrderAmount" class="form-label">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞</label>
                        <div class="input-group">
                            <i class="input-icon fas fa-ruble-sign"></i>
                            <input type="number" 
                                   id="quickOrderAmount" 
                                   name="total_amount" 
                                   class="form-control has-icon" 
                                   min="0"
                                   step="0.01"
                                   placeholder="0.00">
                        </div>
                        <div class="form-text">–ú–æ–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –ø–æ–∑–∂–µ</div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="quickOrderExecutor" class="form-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
                        <select id="quickOrderExecutor" name="executor_id" class="form-control">
                            <option value="">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–∑–∂–µ</option>
                            {% for executor in executors %}
                            <option value="{{ executor.id }}">{{ executor.get_full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è -->
            <div class="form-group">
                <div class="form-check-container">
                    <div class="form-check">
                        <input type="checkbox" 
                               id="quickOrderUrgent" 
                               name="is_urgent" 
                               class="form-check-input">
                        <label for="quickOrderUrgent" class="form-check-label">
                            –°—Ä–æ—á–Ω—ã–π –∑–∞–∫–∞–∑
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <input type="checkbox" 
                               id="quickOrderStartNow" 
                               name="start_immediately" 
                               class="form-check-input">
                        <label for="quickOrderStartNow" class="form-check-label">
                            –ù–∞—á–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—Ä–∞–∑—É
                        </label>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hideModal('quickOrderModal')">
            –û—Ç–º–µ–Ω–∞
        </button>
        <button type="submit" form="quickOrderForm" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>
            –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑
        </button>
    </div>
</div>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ */
.autocomplete-container {
    position: relative;
}

.form-check-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-check {
    display: flex;
    align-items: center;
    gap: 8px;
}

.form-check-input {
    width: 16px;
    height: 16px;
    margin: 0;
    cursor: pointer;
}

.form-check-label {
    font-size: 14px;
    cursor: pointer;
    margin: 0;
}

#quickOrderService {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 8px center;
    background-repeat: no-repeat;
    background-size: 16px 12px;
    padding-right: 32px;
}

#quickOrderPriority,
#quickOrderExecutor {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 8px center;
    background-repeat: no-repeat;
    background-size: 16px 12px;
    padding-right: 32px;
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ä–æ—á–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ */
#quickOrderForm.urgent {
    border-left: 4px solid #dc2626;
}

.form-group.urgent .form-label::after {
    content: " üî•";
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —É—Å–ª—É–≥–∏ */
#quickOrderService option:checked {
    background: var(--primary-color);
    color: var(--text-light);
}

/* –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—É–º–º—ã –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —É—Å–ª—É–≥–∏ */
.service-price-hint {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    color: var(--text-muted);
    pointer-events: none;
}

/* –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ */
.form-control.valid {
    border-color: #059669;
}

.form-control.invalid {
    border-color: #dc2626;
}

.validation-icon {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
    pointer-events: none;
}

.validation-icon.valid {
    color: #059669;
}

.validation-icon.invalid {
    color: #dc2626;
}
</style>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞
document.addEventListener('DOMContentLoaded', function() {
    const serviceSelect = document.getElementById('quickOrderService');
    const amountInput = document.getElementById('quickOrderAmount');
    const urgentCheckbox = document.getElementById('quickOrderUrgent');
    const startNowCheckbox = document.getElementById('quickOrderStartNow');
    const form = document.getElementById('quickOrderForm');
    
    // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—É–º–º—ã –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —É—Å–ª—É–≥–∏
    if (serviceSelect && amountInput) {
        serviceSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            
            if (price && !amountInput.value) {
                amountInput.value = price;
                amountInput.classList.add('valid');
            }
        });
    }
    
    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å—Ä–æ—á–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
    if (urgentCheckbox && form) {
        urgentCheckbox.addEventListener('change', function() {
            form.classList.toggle('urgent', this.checked);
        });
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ "–Ω–∞—á–∞—Ç—å —Å—Ä–∞–∑—É"
    if (startNowCheckbox) {
        startNowCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // –ú–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ "–≤ —Ä–∞–±–æ—Ç–µ"
            }
        });
    }
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    const requiredFields = form.querySelectorAll('[required]');
    requiredFields.forEach(field => {
        field.addEventListener('blur', validateField);
        field.addEventListener('input', debounce(validateField, 300));
    });
    
    function validateField(e) {
        const field = e.target;
        const isValid = field.checkValidity();
        
        field.classList.toggle('valid', isValid && field.value);
        field.classList.toggle('invalid', !isValid && field.value);
        
        // –î–æ–±–∞–≤–ª—è–µ–º/—É–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫—É –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        let icon = field.parentNode.querySelector('.validation-icon');
        if (field.value) {
            if (!icon) {
                icon = document.createElement('i');
                icon.className = 'validation-icon fas';
                field.parentNode.style.position = 'relative';
                field.parentNode.appendChild(icon);
            }
            
            icon.className = `validation-icon fas ${isValid ? 'fa-check valid' : 'fa-times invalid'}`;
        } else if (icon) {
            icon.remove();
        }
    }
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ dashboard.js)
function showQuickOrderModal() {
    const modal = document.getElementById('quickOrderModal');
    const backdrop = document.getElementById('quickOrderModalBackdrop');
    
    if (modal && backdrop) {
        modal.style.display = 'block';
        backdrop.style.display = 'block';
        
        // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
        const firstInput = modal.querySelector('input:not([type="hidden"]):not([disabled])');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª
        document.body.style.overflow = 'hidden';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    const backdrop = document.getElementById(modalId + 'Backdrop');
    
    if (modal) {
        modal.style.display = 'none';
    }
    
    if (backdrop) {
        backdrop.style.display = 'none';
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª
    document.body.style.overflow = '';
    
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    const form = modal.querySelector('form');
    if (form) {
        form.reset();
        form.classList.remove('urgent');
        
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        form.querySelectorAll('.valid, .invalid').forEach(el => {
            el.classList.remove('valid', 'invalid');
        });
        
        // –£–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
        form.querySelectorAll('.validation-icon').forEach(icon => {
            icon.remove();
        });
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const visibleModal = document.querySelector('.modal[style*="display: block"]');
        if (visibleModal) {
            const modalId = visibleModal.id;
            hideModal(modalId);
        }
    }
});
</script>