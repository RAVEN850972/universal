<!-- templates/crm/dashboard.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Главная - {{ current_company.name }}{% endblock %}
{% block page_title %}Добро пожаловать, {{ user.first_name|default:user.username }}!{% endblock %}
{% block page_icon %}tachometer-alt{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block page_content %}
<!-- Статистические карточки -->
<div class="stats-container">
    <div class="stats-grid">
        <!-- Общие статистики -->
        <div class="stats-card primary" data-aos="fade-up" data-aos-delay="100">
            <div class="stats-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stats-content">
                <div class="stats-value">{{ stats.total_clients|default:0 }}</div>
                <div class="stats-label">Всего клиентов</div>
                {% if stats.new_clients_week %}
                <div class="stats-trend positive">
                    <i class="fas fa-arrow-up"></i>
                    +{{ stats.new_clients_week }} за неделю
                </div>
                {% endif %}
            </div>
        </div>

        <div class="stats-card warning" data-aos="fade-up" data-aos-delay="200">
            <div class="stats-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stats-content">
                <div class="stats-value">{{ stats.active_orders|default:0 }}</div>
                <div class="stats-label">
                    {% if company_user.role == 'executor' %}Мои активные заказы{% else %}Активных заказов{% endif %}
                </div>
                {% if stats.new_orders %}
                <div class="stats-trend">
                    <i class="fas fa-plus"></i>
                    {{ stats.new_orders }} новых
                </div>
                {% endif %}
            </div>
        </div>

        {% if company_user.role != 'executor' %}
        <div class="stats-card success" data-aos="fade-up" data-aos-delay="300">
            <div class="stats-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stats-content">
                <div class="stats-value">{{ stats.month_revenue|floatformat:0|default:0 }}₽</div>
                <div class="stats-label">Доход за месяц</div>
                {% if stats.revenue_change %}
                <div class="stats-trend {% if stats.revenue_change > 0 %}positive{% else %}negative{% endif %}">
                    <i class="fas fa-arrow-{% if stats.revenue_change > 0 %}up{% else %}down{% endif %}"></i>
                    {% if stats.revenue_change > 0 %}+{% endif %}{{ stats.revenue_change|floatformat:1 }}%
                </div>
                {% endif %}
            </div>
        </div>

        <div class="stats-card info" data-aos="fade-up" data-aos-delay="400">
            <div class="stats-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stats-content">
                <div class="stats-value">{{ stats.completed_orders_month|default:0 }}</div>
                <div class="stats-label">Завершено за месяц</div>
                {% if stats.completion_rate %}
                <div class="stats-trend">
                    <i class="fas fa-percent"></i>
                    {{ stats.completion_rate|floatformat:1 }}% от общего
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <!-- Статистика для исполнителей -->
        <div class="stats-card success" data-aos="fade-up" data-aos-delay="300">
            <div class="stats-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stats-content">
                <div class="stats-value">{{ stats.my_completed_month|default:0 }}</div>
                <div class="stats-label">Завершено за месяц</div>
            </div>
        </div>

        <div class="stats-card primary" data-aos="fade-up" data-aos-delay="400">
            <div class="stats-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="stats-content">
                <div class="stats-value">{{ stats.my_commission|floatformat:0|default:0 }}₽</div>
                <div class="stats-label">Заработано за месяц</div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Основной контент -->
<div class="dashboard-content">
    <div class="dashboard-grid">
        <!-- Левая колонка -->
        <div class="dashboard-main">
            <!-- Последние заказы -->
            <div class="card dashboard-card" data-aos="fade-up" data-aos-delay="500">
                <div class="card-header">
                    <div class="card-header-content">
                        <h5 class="card-title">
                            {% if company_user.role == 'executor' %}
                                <i class="fas fa-user-check me-2"></i>Мои заказы
                            {% else %}
                                <i class="fas fa-clipboard-list me-2"></i>Последние заказы
                            {% endif %}
                        </h5>
                        <div class="card-actions">
                            {% if company_user.role != 'executor' %}
                            <button class="btn btn-primary btn-sm" onclick="showQuickOrderModal()">
                                <i class="fas fa-plus me-1"></i>Новый заказ
                            </button>
                            {% endif %}
                            <a href="#" class="btn btn-outline btn-sm" onclick="alert('Список заказов - в разработке')">
                                Все заказы
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if recent_orders %}
                    <div class="orders-list">
                        {% for order in recent_orders %}
                        <div class="order-item" onclick="openOrderDetails({{ order.id }})">
                            <div class="order-main">
                                <div class="order-info">
                                    <div class="order-header">
                                        <span class="order-number">Заказ #{{ order.id }}</span>
                                        <span class="order-status status-{{ order.status }}">
                                            {% if order.status == 'new' %}Новый
                                            {% elif order.status == 'in_progress' %}В работе
                                            {% elif order.status == 'completed' %}Завершен
                                            {% elif order.status == 'cancelled' %}Отменен
                                            {% endif %}
                                        </span>
                                    </div>
                                    <div class="order-client">
                                        <i class="fas fa-user me-1"></i>
                                        {{ order.client.name }}
                                    </div>
                                    <div class="order-meta">
                                        <span class="order-date">
                                            <i class="fas fa-calendar me-1"></i>
                                            {{ order.order_date|date:"d.m.Y" }}
                                        </span>
                                        {% if order.total_amount %}
                                        <span class="order-amount">
                                            <i class="fas fa-ruble-sign me-1"></i>
                                            {{ order.total_amount|floatformat:0 }}₽
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if order.description %}
                                <div class="order-description">
                                    {{ order.description|truncatechars:80 }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="order-actions">
                                {% if company_user.role != 'executor' or order.status == 'in_progress' %}
                                <div class="status-actions">
                                    {% if order.status == 'new' %}
                                    <button class="btn btn-sm btn-success" onclick="updateOrderStatus({{ order.id }}, 'in_progress', event)">
                                        <i class="fas fa-play"></i>
                                    </button>
                                    {% elif order.status == 'in_progress' %}
                                    <button class="btn btn-sm btn-primary" onclick="updateOrderStatus({{ order.id }}, 'completed', event)">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                {% endif %}
                                <i class="fas fa-chevron-right order-arrow"></i>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <h6>Заказов пока нет</h6>
                        <p class="text-muted">
                            {% if company_user.role == 'executor' %}
                                Вам пока не назначены заказы
                            {% else %}
                                Создайте первый заказ для начала работы
                            {% endif %}
                        </p>
                        {% if company_user.role != 'executor' %}
                        <button class="btn btn-primary" onclick="showQuickOrderModal()">
                            <i class="fas fa-plus me-2"></i>Создать заказ
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Активность по дням -->
            {% if company_user.role != 'executor' %}
            <div class="card dashboard-card" data-aos="fade-up" data-aos-delay="600">
                <div class="card-header">
                    <div class="card-header-content">
                        <h5 class="card-title">
                            <i class="fas fa-chart-bar me-2"></i>Активность за неделю
                        </h5>
                    </div>
                </div>
                <div class="card-body">
                    <div class="activity-chart">
                        <canvas id="weeklyActivity" height="200"></canvas>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Правая колонка -->
        <div class="dashboard-sidebar">
            <!-- Быстрые действия -->
            <div class="card quick-actions-card" data-aos="fade-up" data-aos-delay="700">
                <div class="card-header">
                    <h6 class="card-title">
                        <i class="fas fa-bolt me-2"></i>Быстрые действия
                    </h6>
                </div>
                <div class="card-body">
                    <div class="quick-actions">
                        {% if company_user.role != 'executor' %}
                        <button class="quick-action-btn" onclick="showQuickOrderModal()">
                            <i class="fas fa-plus"></i>
                            <span>Новый заказ</span>
                        </button>
                        
                        <button class="quick-action-btn" onclick="showQuickClientModal()">
                            <i class="fas fa-user-plus"></i>
                            <span>Новый клиент</span>
                        </button>
                        
                        <a href="#" class="quick-action-btn" onclick="alert('Отчеты - в разработке')">
                            <i class="fas fa-chart-line"></i>
                            <span>Отчеты</span>
                        </a>
                        {% endif %}
                        
                        <a href="#" class="quick-action-btn" onclick="alert('Мои заказы - в разработке')">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Мои заказы</span>
                        </a>
                        
                        {% if company_user.role == 'executor' %}
                        <a href="#" class="quick-action-btn" onclick="alert('Моя зарплата - в разработке')">
                            <i class="fas fa-wallet"></i>
                            <span>Моя зарплата</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Недавние клиенты -->
            {% if company_user.role != 'executor' %}
            <div class="card dashboard-card" data-aos="fade-up" data-aos-delay="800">
                <div class="card-header">
                    <div class="card-header-content">
                        <h6 class="card-title">
                            <i class="fas fa-users me-2"></i>Недавние клиенты
                        </h6>
                        <a href="#" class="card-link" onclick="alert('Список клиентов - в разработке')">Все клиенты</a>
                    </div>
                </div>
                <div class="card-body">
                    {% if recent_clients %}
                    <div class="clients-list">
                        {% for client in recent_clients %}
                        <div class="client-item" onclick="openClientDetails({{ client.id }})">
                            <div class="client-avatar">
                                {{ client.name.0|upper }}
                            </div>
                            <div class="client-info">
                                <div class="client-name">{{ client.name }}</div>
                                <div class="client-meta">
                                    {% if client.phone %}
                                    <span class="client-phone">{{ client.phone }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="client-orders">
                                <span class="orders-count">{{ client.orders_count|default:0 }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state-small">
                        <i class="fas fa-users text-muted"></i>
                        <p class="text-muted">Клиентов пока нет</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Календарь задач -->
            <div class="card dashboard-card" data-aos="fade-up" data-aos-delay="900">
                <div class="card-header">
                    <div class="card-header-content">
                        <h6 class="card-title">
                            <i class="fas fa-calendar-alt me-2"></i>Сегодня
                        </h6>
                        <span class="current-date">{{ today|date:"d.m.Y" }}</span>
                    </div>
                </div>
                <div class="card-body">
                    {% if today_tasks %}
                    <div class="today-tasks">
                        {% for task in today_tasks %}
                        <div class="task-item">
                            <div class="task-time">{{ task.time|date:"H:i" }}</div>
                            <div class="task-content">
                                <div class="task-title">{{ task.title }}</div>
                                {% if task.client %}
                                <div class="task-client">{{ task.client.name }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state-small">
                        <i class="fas fa-calendar-check text-muted"></i>
                        <p class="text-muted">На сегодня задач нет</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальные окна -->
<div class="modal-backdrop" id="quickOrderModalBackdrop" style="display: none;" onclick="hideModal('quickOrderModal')"></div>
<div class="modal" id="quickOrderModal" style="display: none;">
    <div class="modal-header">
        <h5 class="modal-title">
            <i class="fas fa-plus-circle me-2"></i>
            Быстрое создание заказа
        </h5>
        <button type="button" class="modal-close" onclick="hideModal('quickOrderModal')">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="modal-body">
        <form id="quickOrderForm" novalidate>
            {% csrf_token %}
            
            <!-- Основные поля -->
            <div class="form-group">
                <label for="quickOrderClient" class="form-label required">Клиент</label>
                <div class="input-group">
                    <i class="input-icon fas fa-user"></i>
                    <input type="text" 
                           id="quickOrderClient" 
                           name="client_name" 
                           class="form-control has-icon" 
                           placeholder="Имя клиента"
                           required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="quickOrderDescription" class="form-label required">Описание работ</label>
                <textarea id="quickOrderDescription" 
                          name="description" 
                          class="form-control" 
                          rows="3"
                          placeholder="Опишите, что нужно сделать..."
                          required></textarea>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="quickOrderDate" class="form-label required">Дата заказа</label>
                        <input type="date" 
                               id="quickOrderDate" 
                               name="order_date" 
                               class="form-control" 
                               required
                               value="{{ today|date:'Y-m-d' }}">
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="quickOrderAmount" class="form-label">Сумма</label>
                        <div class="input-group">
                            <input type="number" 
                                   id="quickOrderAmount" 
                                   name="total_amount" 
                                   class="form-control" 
                                   min="0"
                                   step="0.01"
                                   placeholder="0.00">
                            <span class="input-group-text">₽</span>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hideModal('quickOrderModal')">
            Отмена
        </button>
        <button type="submit" form="quickOrderForm" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>
            Создать заказ
        </button>
    </div>
</div>

<!-- Модальное окно создания клиента -->
<div class="modal-backdrop" id="quickClientModalBackdrop" style="display: none;" onclick="hideModal('quickClientModal')"></div>
<div class="modal" id="quickClientModal" style="display: none;">
    <div class="modal-header">
        <h5 class="modal-title">
            <i class="fas fa-user-plus me-2"></i>
            Быстрое создание клиента
        </h5>
        <button type="button" class="modal-close" onclick="hideModal('quickClientModal')">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="modal-body">
        <form id="quickClientForm" novalidate>
            {% csrf_token %}
            
            <div class="form-group">
                <label for="quickClientName" class="form-label required">Имя</label>
                <div class="input-group">
                    <i class="input-icon fas fa-user"></i>
                    <input type="text" 
                           id="quickClientName" 
                           name="name" 
                           class="form-control has-icon" 
                           placeholder="Введите имя клиента"
                           required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="quickClientPhone" class="form-label required">Телефон</label>
                <div class="input-group">
                    <i class="input-icon fas fa-phone"></i>
                    <input type="tel" 
                           id="quickClientPhone" 
                           name="phone" 
                           class="form-control has-icon" 
                           placeholder="+7 (___) ___-__-__"
                           required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="quickClientEmail" class="form-label">Email</label>
                <div class="input-group">
                    <i class="input-icon fas fa-envelope"></i>
                    <input type="email" 
                           id="quickClientEmail" 
                           name="email" 
                           class="form-control has-icon" 
                           placeholder="example@domain.com">
                </div>
            </div>
            
            <div class="form-group">
                <label for="quickClientAddress" class="form-label">Адрес</label>
                <textarea id="quickClientAddress" 
                          name="address" 
                          class="form-control" 
                          rows="2"
                          placeholder="Укажите адрес клиента..."></textarea>
            </div>
        </form>
    </div>
    
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hideModal('quickClientModal')">
            Отмена
        </button>
        <button type="submit" form="quickClientForm" class="btn btn-primary">
            <i class="fas fa-user-plus me-1"></i>
            Создать клиента
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}

{% block inline_js %}
<script>
// Данные для графика активности
{% if company_user.role != 'executor' %}
const weeklyData = {
    labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
    datasets: [{
        label: 'Заказы',
        data: [2, 4, 3, 7, 5, 6, 1],
        backgroundColor: 'var(--primary-color)',
        borderRadius: 4
    }]
};

// Инициализация графика
const ctx = document.getElementById('weeklyActivity');
if (ctx) {
    new Chart(ctx, {
        type: 'bar',
        data: weeklyData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}
{% endif %}

// Функции для модальных окон
function showQuickOrderModal() {
    const modal = document.getElementById('quickOrderModal');
    const backdrop = document.getElementById('quickOrderModalBackdrop');
    
    if (modal && backdrop) {
        modal.style.display = 'block';
        backdrop.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        const firstInput = modal.querySelector('input:not([type="hidden"])');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }
    }
}

function showQuickClientModal() {
    const modal = document.getElementById('quickClientModal');
    const backdrop = document.getElementById('quickClientModalBackdrop');
    
    if (modal && backdrop) {
        modal.style.display = 'block';
        backdrop.style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        const firstInput = modal.querySelector('input:not([type="hidden"])');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    const backdrop = document.getElementById(modalId + 'Backdrop');
    
    if (modal) {
        modal.style.display = 'none';
    }
    
    if (backdrop) {
        backdrop.style.display = 'none';
    }
    
    document.body.style.overflow = '';
    
    // Очищаем форму
    const form = modal.querySelector('form');
    if (form) {
        form.reset();
    }
}

function openOrderDetails(orderId) {
    alert('Детали заказа #' + orderId + ' - в разработке');
}

function openClientDetails(clientId) {
    alert('Детали клиента #' + clientId + ' - в разработке');
}

function updateOrderStatus(orderId, newStatus, event) {
    if (event) {
        event.stopPropagation();
    }
    
    const statusText = {
        'in_progress': 'В работе',
        'completed': 'Завершен'
    };
    
    if (confirm(`Изменить статус заказа на "${statusText[newStatus]}"?`)) {
        alert('Обновление статуса - в разработке');
    }
}

// Обработка форм
document.getElementById('quickOrderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    alert('Создание заказа - в разработке');
    hideModal('quickOrderModal');
});

document.getElementById('quickClientForm').addEventListener('submit', function(e) {
    e.preventDefault();
    alert('Создание клиента - в разработке');
    hideModal('quickClientModal');
});

// Закрытие модальных окон по Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const visibleModal = document.querySelector('.modal[style*="display: block"]');
        if (visibleModal) {
            const modalId = visibleModal.id;
            hideModal(modalId);
        }
    }
});
</script>
{% endblock %}